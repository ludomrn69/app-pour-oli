<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Admin - Ludo & Oli</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com;
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https://firebasestorage.googleapis.com;
        connect-src 'self' https://*.firebaseio.com https://*.googleapis.com;
        font-src 'self' data:;
        object-src 'none';
        frame-ancestors 'none';
    ">

    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- Progressive Web App -->
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="OLI & Ludo ❤️">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>❤️</text></svg>">

    <!-- Preconnect pour améliorer les performances -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://firebasestorage.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <style>
        /* Toggle souvenirs/messages - curved colorful design */
        #toggleContainer {
          margin-top: 40px !important;
        }
        #toggleContainer > div {
            border-radius: 40px;
            background: linear-gradient(to right, #ffffff, #f2f2f2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 5px;
            display: inline-flex;
            overflow: hidden;
        }

        #showMemoriesBtn,
        #showMessagesBtn {
            flex: 1;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #333;
        }

        #showMemoriesBtn.active,
        #showMessagesBtn.active {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Navbar Styles (Messages Menu Matching) --- */
        .navbar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: rgba(255, 255, 255, 0.97);
          backdrop-filter: blur(16px);
          border-bottom: 1px solid rgba(0,0,0,0.08);
          z-index: 1000;
          box-shadow: 0 2px 12px rgba(0,0,0,0.07);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 24px;
        }

        .navbar-brand-wrapper {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .navbar-brand {
          font-size: 18px;
          font-weight: 700;
          background: linear-gradient(to right, #ff6b6b, #feca57, #48dbfb);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        #toggleMenu {
          display: none;
          background: none;
          border: none;
          font-size: 24px;
          padding: 4px 10px;
          cursor: pointer;
          color: #ff6b6b;
          border-radius: 8px;
          transition: background 0.2s;
        }
        #toggleMenu:active,
        #toggleMenu:focus {
          background: rgba(255, 107, 107, 0.1);
          outline: none;
        }

        .navbar-nav {
          display: flex;
          flex-direction: row;
          gap: 10px;
          list-style: none;
          align-items: center;
          margin: 0;
          padding: 0;
        }

        .navbar-nav li {
          list-style: none;
        }

        .nav-link {
          text-decoration: none;
          color: #2c3e50;
          font-weight: 500;
          padding: 8px 16px;
          border-radius: 20px;
          transition: all 0.3s ease;
          font-size: 14px;
          display: inline-block;
        }
        .nav-link:hover {
          background: rgba(255, 107, 107, 0.1);
          color: #ff6b6b;
          transform: translateY(-1px);
        }
        .nav-link.active {
          background: linear-gradient(135deg, #ff6b6b, #feca57);
          color: white;
          box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        @media (max-width: 800px) {
            .navbar {
                flex-direction: column;
                align-items: stretch;
                padding: 8px 10px;
            }
            .navbar-brand-wrapper {
                width: 100%;
                justify-content: space-between;
            }
            .navbar-nav {
                flex-direction: column;
                width: 100%;
                gap: 10px;
                margin-top: 8px;
                margin-bottom: 4px;
                display: none;
            }
            .navbar-nav li {
                width: 100%;
            }
            .nav-link {
                width: 100%;
                text-align: left;
                font-size: 15px;
                padding: 10px 18px;
            }
            #toggleMenu {
                display: block;
            }
        }
        @media (max-width: 480px) {
            .navbar {
                padding: 6px 3vw;
            }
            .navbar-brand {
                font-size: 16px;
            }
            .nav-link {
                font-size: 12px;
                padding: 8px 10px;
            }
            body {
                padding-top: 60px;
            }
        }

        .main-container {
            margin-top: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: stretch;
            min-height: calc(100vh - 120px);
        }

        .admin-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 20px;
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .section-content {
            padding: 30px;
        }

        #deleteMemoriesList {
            overflow-y: auto;
            max-height: 100vh;
            height: 100%;
        }
        #deleteMessagesList {
            height: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 12px 16px;
            background: rgba(255, 107, 107, 0.1);
            border: 2px dashed #ff6b6b;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ff6b6b;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-container {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .preview-wrapper {
            position: relative;
            display: inline-block;
        }

        .preview-image {
            max-width: 120px;
            max-height: 120px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }

        .remove-photo-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .remove-photo-btn:hover {
            background: rgba(255, 0, 0, 1);
        }

        .success-message, .error-message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Styles pour la galerie de photos dans les cartes */
        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .gallery-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .gallery-image:hover {
            transform: scale(1.1);
        }

        /* Modal pour agrandir les images */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .admin-section:first-of-type {
                width: 100% ;
                max-width: 100%;
                height: auto !important;
            }
            
            .section-content {
                padding: 20px;
            }

            .preview-image {
                max-width: 100px;
                max-height: 100px;
            }

            .gallery-image {
                width: 60px;
                height: 60px;
            }
        }

        /* Style personnalisé pour les menus déroulants .form-select */
        .form-select {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-color: white;
          background-image: url("data:image/svg+xml,%3Csvg fill='none' height='16' viewBox='0 0 24 24' width='16' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23666' stroke-width='2'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 1rem center;
          background-size: 16px;
          padding-right: 3rem;
          border: 2px solid rgba(255, 107, 107, 0.2);
          border-radius: 12px;
          height: 48px;
          line-height: 1.2;
          font-size: 15px;
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .form-select:hover {
          border-color: #ff6b6b;
          box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
        }

        .form-select:focus {
          outline: none;
          border-color: #ff6b6b;
          box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="navbar-brand-wrapper">
        <div class="navbar-brand">Oli & Ludo</div>
        <button id="toggleMenu">☰</button>
      </div>
      <ul class="navbar-nav" id="navbarNav">
        <li><a href="index.html" class="nav-link">Accueil</a></li>
        <li><a href="souvenirs.html" class="nav-link">Souvenirs</a></li>
        <li><a href="messages.html" class="nav-link">Messages</a></li>
        <li><a href="voyages.html" class="nav-link">Voyages</a></li>
        <li><a href="admin.html" class="nav-link active">Admin</a></li>
        <li><a href="#" class="nav-link" onclick="logout()">Déconnexion</a></li>
      </ul>
    </nav>

    <!-- Toggle souvenirs/messages -->
    <div id="toggleContainer" style="margin-top: 40px; text-align: center;">
        <div>
            <button id="showMemoriesBtn" class="toggle-btn">Souvenirs</button>
            <button id="showMessagesBtn" class="toggle-btn">Messages</button>
        </div>
    </div>

    <!-- Login Form (hidden after login) -->
    <div id="loginContainer" class="login-container">
        <div class="section-header">
            <h2>Connexion Admin 🔐</h2>
        </div>
        <div class="section-content">
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <button type="submit" class="submit-btn">Se connecter</button>
            </form>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal pour agrandir les images -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="">
        </div>
    </div>

    <!-- Admin Interface (hidden until login) -->
    <div id="adminInterface" class="main-container" style="display: none;">
        <!-- Add Memory Section -->
        <div class="admin-section" style="height: auto;">
            <div class="section-header">
                <h2>Ajouter un Souvenir 💫</h2>
            </div>
            <div class="section-content">
                <form id="memoryForm">
                    <div class="form-group">
                        <label class="form-label">Titre du souvenir</label>
                        <input type="text" id="memoryTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lieu associé</label>
                        <select id="memoryLocation" class="form-select">
                            <option value="">Aucun lieu</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="memoryDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="memoryDescription" class="form-textarea" placeholder="Raconte ce beau souvenir..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Photos (optionnelles)</label>
                        <div class="file-input-container">
                            <input type="file" id="memoryPhoto" class="file-input" accept="image/*" multiple>
                            <label for="memoryPhoto" class="file-input-label">
                                📸 Choisir des photos
                            </label>
                        </div>
                        <div id="memoryPreview" class="preview-container"></div>
                    </div>
                    <button type="submit" class="submit-btn" id="memorySubmit">
                        Ajouter le souvenir ✨
                    </button>
                </form>
                <div id="memoryMessage"></div>
            </div>
        </div>

        <!-- Add Message Section -->
        <div class="admin-section" style="height: 100%; display: flex; flex-direction: column;">
            <div class="section-header">
                <h2>Ajouter une Conversation 💬</h2>
            </div>
            <div class="section-content" style="flex-grow: 1; display: flex; flex-direction: column;">
                <form id="messageForm" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;">
                    <div class="form-group">
                        <label class="form-label">Titre de la conversation</label>
                        <input type="text" id="messageTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de la conversation</label>
                        <input type="date" id="messageDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="messageDescription" class="form-textarea" placeholder="Contexte de cette conversation..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Screenshots de la conversation</label>
                        <div class="file-input-container">
                            <input type="file" id="messagePhoto" class="file-input" accept="image/*" multiple>
                            <label for="messagePhoto" class="file-input-label">
                                📱 Choisir les screenshots
                            </label>
                        </div>
                        <div id="messagePreview" class="preview-container"></div>
                    </div>
                    <button type="submit" class="submit-btn" id="messageSubmit">
                        Ajouter la conversation 💕
                    </button>
                </form>
                <div id="messageMessage"></div>
            </div>
        </div>
        <div class="admin-section" style="height: 100%; display: flex; flex-direction: column;">
            <div class="section-header" style="flex-shrink: 0;">
                <h2>Modifier ou supprimer un souvenir ✏️🗑</h2>
            </div>
            <div class="section-content" id="deleteMemoriesList">
                Chargement des souvenirs...
            </div>
        </div>

        <div class="admin-section" style="height: 100%; display: flex; flex-direction: column;">
            <div class="section-header">
                <h2>Modifier ou supprimer une conv ✏️🗑</h2>
            </div>
            <div class="section-content" id="deleteMessagesList" style="overflow-y: auto; flex-grow: 1;">
                Chargement des messages...
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
        import { deleteDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { deleteObject } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgQKaAsFmfrD_ejm5uRYS5QE1nMN-qTfM",
            authDomain: "app-pour-oli.firebaseapp.com",
            projectId: "app-pour-oli",
            storageBucket: "app-pour-oli.firebasestorage.app",
            messagingSenderId: "80626914562",
            appId: "1:80626914562:web:3f51556e811a287580de1b",
            measurementId: "G-R9E5D06XB6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Elements
        const loginContainer = document.getElementById('loginContainer');
        const adminInterface = document.getElementById('adminInterface');
        const loginForm = document.getElementById('loginForm');
        const memoryForm = document.getElementById('memoryForm');
        const messageForm = document.getElementById('messageForm');

        // Fonction pour charger les lieux depuis Firestore et remplir les dropdowns
        async function populateLocationDropdowns() {
            const placesSnap = await getDocs(collection(db, "visited-places"));
            const locations = placesSnap.docs.map(doc => doc.data().name).sort((a, b) => a.localeCompare(b));

            const memorySelect = document.getElementById("memoryLocation");

            locations.forEach(name => {
                const option1 = document.createElement("option");
                option1.value = name;
                option1.textContent = name;
                memorySelect.appendChild(option1);
            });
        }

        // Modal pour agrandir les images
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const closeModal = document.querySelector('.close-modal');

        function openImageModal(src) {
            modal.style.display = 'block';
            modalImg.src = src;
        }

        closeModal.onclick = function() {
            modal.style.display = 'none';
        }

        modal.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginContainer.style.display = 'none';
                adminInterface.style.display = 'grid';
                document.getElementById("toggleContainer").style.display = "block";
                // Ajout du message de bienvenue personnalisé dans la navbar
                const greeting = document.getElementById('navbarGreeting');
                renderDeletableItems("memories", "deleteMemoriesList");
                renderDeletableItems("conversations", "deleteMessagesList");
                greeting.textContent = `Bonjour, ${user.email} 👋`;
                greeting.style.fontWeight = '500';
                greeting.style.fontSize = '14px';
                greeting.style.color = 'white';
                // Charger les lieux pour les dropdowns
                populateLocationDropdowns();
            } else {
                loginContainer.style.display = 'block';
                adminInterface.style.display = 'none';
            }
            // Force a full reload once to ensure freshness
            if (!window.location.hash.includes("#reloaded")) {
                window.location.replace(window.location.href + "#reloaded");
                window.location.reload();
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.style.display = 'none';
            } catch (error) {
                errorDiv.textContent = 'Erreur de connexion: ' + error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.reload(); // force reload to clear greeting
            } catch (error) {
                console.error('Erreur de déconnexion:', error);
            }
        };

        // Variables pour gérer l'édition
        let currentMemoryPhotos = [];
        let currentMessagePhotos = [];

        // Preview images avec gestion multiple améliorée
        document.getElementById('memoryPhoto').addEventListener('change', (e) => {
            handleMultipleImagePreview(e.target, 'memoryPreview', 'memory');
        });

        document.getElementById('messagePhoto').addEventListener('change', (e) => {
            handleMultipleImagePreview(e.target, 'messagePreview', 'message');
        });

        function handleMultipleImagePreview(input, containerId, type) {
            const container = document.getElementById(containerId);
            
            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        createPreviewWrapper(e.target.result, container, type, true);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function createPreviewWrapper(src, container, type, isNewFile = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper';
            wrapper.setAttribute('data-new-file', isNewFile);
            wrapper.setAttribute('data-src', src);

            const img = document.createElement('img');
            img.src = src;
            img.className = 'preview-image';
            img.onclick = () => openImageModal(src);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-photo-btn';
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';
            removeBtn.onclick = (e) => {
                e.preventDefault();
                if (type === 'memory') {
                    // Retire l'image supprimée de la liste des anciennes
                    currentMemoryPhotos = currentMemoryPhotos.filter(url => url !== src);
                    // Supprime aussi du DOM
                    wrapper.remove();
                } else if (type === 'message') {
                    // Retire l'image supprimée de la liste des anciennes
                    currentMessagePhotos = currentMessagePhotos.filter(url => {
                        // Comparaison robuste pour éviter les erreurs dues aux tokens ou aux différences d'URL
                        const cleanUrl = url.split('?')[0];
                        const cleanSrc = src.split('?')[0];
                        return !cleanUrl.includes(cleanSrc);
                    });
                    // Supprime aussi du DOM
                    wrapper.remove();
                    // After removal, enable/disable the submit button accordingly
                    const messageSubmitBtn = document.getElementById('messageSubmit');
                    if (currentMessagePhotos.length > 0 || document.getElementById('messagePhoto').files.length > 0) {
                        messageSubmitBtn.disabled = false;
                    } else {
                        messageSubmitBtn.disabled = true;
                    }
                }
            };

            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);

            // Ajouter à la liste des anciennes images si ce n’est pas un nouveau fichier
            if (!isNewFile && type === 'message' && !currentMessagePhotos.includes(src)) {
                currentMessagePhotos.push(src);
            }
            // Ajouter à la liste des photos actuelles si ce n'est pas un nouveau fichier
            if (!isNewFile) {
                if (type === 'memory' && !currentMemoryPhotos.includes(src)) {
                    currentMemoryPhotos.push(src);
                }
            }
        }

        // Upload image to Firebase Storage
        async function uploadImage(file, folder) {
            const timestamp = Date.now();
            const fileName = `${folder}/${timestamp}_${file.name}`;
            const storageRef = ref(storage, fileName);
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        }

        // Upload multiple images to Firebase Storage
        async function uploadMultipleImages(files, folder) {
            const urls = [];
            for (const file of files) {
                const url = await uploadImage(file, folder);
                urls.push(url);
            }
            return urls;
        }

        // Global editing state
        let editingItem = null;
        let editingType = null;

        // Add memory
        memoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('memorySubmit');
            const messageDiv = document.getElementById('memoryMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = editingItem && editingType === 'memories' ? 'Modification en cours...' : 'Ajout en cours...';

            try {
                const title = document.getElementById('memoryTitle').value;
                const date = document.getElementById('memoryDate').value;
                const description = document.getElementById('memoryDescription').value;
                const photoFiles = document.getElementById('memoryPhoto').files;
                const location = document.getElementById('memoryLocation').value;

                // Edition mode
                if (editingItem && editingType === 'memories') {
                    // Récupérer les nouvelles images à uploader
                    const newFileWrappers = document.querySelectorAll('#memoryPreview .preview-wrapper[data-new-file="true"]');
                    const newFiles = [];
                    
                    // Convertir les nouveaux fichiers en File objects
                    for (let i = 0; i < photoFiles.length; i++) {
                        newFiles.push(photoFiles[i]);
                    }

                    // Upload des nouvelles images
                    let newPhotoURLs = [];
                    if (newFiles.length > 0) {
                        newPhotoURLs = await uploadMultipleImages(newFiles, 'memories');
                    }

                    // Combiner les anciennes photos conservées avec les nouvelles
                    const finalPhotoURLs = [...currentMemoryPhotos, ...newPhotoURLs];

                    await updateDoc(doc(db, 'memories', editingItem), {
                        title,
                        date,
                        description,
                        photoURLs: finalPhotoURLs,
                        location
                    });

                    messageDiv.innerHTML = '<div class="success-message">Souvenir modifié avec succès ! ✨</div>';
                    resetMemoryForm();
                    renderDeletableItems("memories", "deleteMemoriesList");
                    window.location.reload();
                } else {
                    // Mode ajout
                    let photoURLs = [];
                    if (photoFiles.length > 0) {
                        photoURLs = await uploadMultipleImages(photoFiles, 'memories');
                    }

                    await addDoc(collection(db, 'memories'), {
                        title,
                        date,
                        description,
                        photoURLs: photoURLs,
                        location,
                        createdAt: serverTimestamp(),
                        createdBy: auth.currentUser.email
                    });

                    messageDiv.innerHTML = '<div class="success-message">Souvenir ajouté avec succès ! ✨</div>';
                    resetMemoryForm();
                    window.location.reload();
                }

            } catch (error) {
                messageDiv.innerHTML = `<div class="error-message">Erreur: ${error.message}</div>`;
            }

            submitBtn.disabled = false;
            submitBtn.textContent = editingItem && editingType === 'memories' ? 'Modifier le souvenir ✨' : 'Ajouter le souvenir ✨';
        });

        // Add message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('messageSubmit');
            const messageDiv = document.getElementById('messageMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = editingItem && editingType === 'conversations' ? 'Modification en cours...' : 'Ajout en cours...';

            try {
                const date = document.getElementById('messageDate').value;
                const description = document.getElementById('messageDescription').value;
                const title = document.getElementById('messageTitle').value;
                const photoFiles = document.getElementById('messagePhoto').files;

                // Vérification obligatoire d'au moins une image (en preview ou nouvelle)
                const hasOldPhotos = currentMessagePhotos.length > 0;
                const hasNewPhotos = photoFiles && photoFiles.length > 0;

                if (!hasOldPhotos && !hasNewPhotos) {
                    throw new Error('Au moins une image est requise pour les conversations');
                }

                // Edition mode
                if (editingItem && editingType === 'conversations') {
                    const newFiles = [];
                    for (let i = 0; i < photoFiles.length; i++) {
                        newFiles.push(photoFiles[i]);
                    }

                    let newPhotoURLs = [];
                    if (newFiles.length > 0) {
                        newPhotoURLs = await uploadMultipleImages(newFiles, 'messages');
                    }

                    const finalPhotoURLs = [...currentMessagePhotos, ...newPhotoURLs];

                    await updateDoc(doc(db, 'conversations', editingItem), {
                        title,
                        date,
                        description,
                        photoURLs: finalPhotoURLs,
                        updatedAt: serverTimestamp()
                    });

                    messageDiv.innerHTML = '<div class="success-message">Conversation modifiée avec succès ! 💕</div>';
                    resetMessageForm();
                    renderDeletableItems("conversations", "deleteMessagesList");
                    window.location.reload();
                } else {
                    // Mode ajout
                    const photoURLs = await uploadMultipleImages(photoFiles, 'messages');

                    await addDoc(collection(db, 'conversations'), {
                        title,
                        date,
                        description,
                        photoURLs: photoURLs,
                        createdAt: serverTimestamp(),
                        createdBy: auth.currentUser.email
                    });

                    messageDiv.innerHTML = '<div class="success-message">Conversation ajoutée avec succès ! 💕</div>';
                    resetMessageForm();
                    window.location.reload();
                }

            } catch (error) {
                messageDiv.innerHTML = `<div class="error-message">Erreur: ${error.message}</div>`;
            }

            submitBtn.disabled = false;
            submitBtn.textContent = editingItem && editingType === 'conversations' ? 'Modifier la conversation 💕' : 'Ajouter la conversation 💕';
        });

        function resetMemoryForm() {
            editingItem = null;
            editingType = null;
            currentMemoryPhotos = [];
            document.getElementById('memorySubmit').textContent = 'Ajouter le souvenir ✨';
            document.getElementById('cancelMemoryEdit').style.display = 'none';
            memoryForm.reset();
            document.getElementById('memoryPreview').innerHTML = '';
        }

        function resetMessageForm() {
            editingItem = null;
            editingType = null;
            document.getElementById('messagePreview').innerHTML = '';
            currentMessagePhotos = [];
            document.getElementById('messageSubmit').textContent = 'Ajouter la conversation 💕';
            document.getElementById('cancelMessageEdit').style.display = 'none';
            messageForm.reset();
        }

        async function renderDeletableItems(collectionName, containerId) {
            const snapshot = await getDocs(collection(db, collectionName));
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                // Format date in dd/MM/yyyy with leading zeros
                const dateObj = data.date ? new Date(data.date) : null;
                const formattedDate = dateObj
                    ? `${dateObj.getDate().toString().padStart(2, '0')}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getFullYear()}`
                    : '';
                const card = document.createElement('div');
                card.style.border = '1px solid #ccc';
                card.style.padding = '15px';
                card.style.marginBottom = '15px';
                card.style.borderRadius = '15px';
                card.style.background = '#fff';
                card.style.marginTop = '20px';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';

                // Créer la galerie de photos
                let photoGalleryHTML = '';
                if (Array.isArray(data.photoURLs) && data.photoURLs.length > 0) {
                    photoGalleryHTML = `
                        <div class="photo-gallery">
                            ${data.photoURLs.map(url => `
                                <img src="${url}" class="gallery-image" onclick="openImageModal('${url}')" alt="Photo">
                            `).join('')}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #2c3e50; font-size: 16px;">${data.title || 'Message'}</strong>
                        <div style="background: #f1f2f6; color: #2c3e50; font-size: 14px; font-weight: 600; padding: 6px 14px; border-radius: 999px;">
                            ${formattedDate}
                        </div>
                    </div>
                    <p style="font-size: 14px; color: #34495e; word-wrap: break-word; white-space: pre-wrap; margin-bottom: 12px; line-height: 1.4;">${data.description}</p>
                    ${photoGalleryHTML}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        ${data.location ? `
                            <div style="color: white; background: linear-gradient(135deg, #a18cd1, #fbc2eb); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                📍 ${data.location}
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 10px;">
                            <button class="edit-button" style="background: linear-gradient(135deg, #ffa500, #ff8c00); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: transform 0.2s;">
                                ✏️ Modifier
                            </button>
                            <button class="delete-button" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: transform 0.2s;">
                               🗑️ Supprimer
                            </button>
                        </div>
                    </div>
                `;

                // Ajouter les effets hover
                const editBtn = card.querySelector('.edit-button');
                const deleteBtn = card.querySelector('.delete-button');
                
                editBtn.addEventListener('mouseenter', () => editBtn.style.transform = 'translateY(-2px)');
                editBtn.addEventListener('mouseleave', () => editBtn.style.transform = 'translateY(0)');
                deleteBtn.addEventListener('mouseenter', () => deleteBtn.style.transform = 'translateY(-2px)');
                deleteBtn.addEventListener('mouseleave', () => deleteBtn.style.transform = 'translateY(0)');

                // Supprimer
                deleteBtn.addEventListener('click', async () => {
                    if (confirm("Tu es sûr(e) de vouloir supprimer ?")) {
                        try {
                            await deleteDoc(doc(db, collectionName, docSnap.id));
                            if (Array.isArray(data.photoURLs)) {
                                for (const url of data.photoURLs) {
                                    try {
                                        const path = url.split('/o/')[1].split('?')[0];
                                        const decodedPath = decodeURIComponent(path);
                                        const storageRefToDelete = ref(storage, decodedPath);
                                        await deleteObject(storageRefToDelete);
                                    } catch (storageError) {
                                        console.log('Erreur lors de la suppression du fichier:', storageError);
                                    }
                                }
                            }
                            card.remove();
                        } catch (err) {
                            alert("Erreur lors de la suppression : " + err.message);
                        }
                    }
                });

                // Modifier
                editBtn.addEventListener('click', () => {
                    editingItem = docSnap.id;
                    editingType = collectionName;

                    if (collectionName === "memories") {
                        currentMemoryPhotos = Array.isArray(data.photoURLs) ? [...data.photoURLs] : [];
                        
                        document.getElementById('memoryTitle').value = data.title || '';
                        document.getElementById('memoryDate').value = data.date || '';
                        document.getElementById('memoryDescription').value = data.description || '';
                        document.getElementById('memoryLocation').value = data.location || '';
                        document.getElementById('memorySubmit').textContent = 'Modifier le souvenir ✨';
                        document.getElementById('cancelMemoryEdit').style.display = 'block';
                        
                        // Reset preview et ajouter les photos existantes
                        const previewContainer = document.getElementById('memoryPreview');
                        previewContainer.innerHTML = '';
                        
                        currentMemoryPhotos.forEach(url => {
                            createPreviewWrapper(url, previewContainer, 'memory', false);
                        });

                    } else if (collectionName === "conversations") {
                        currentMessagePhotos = Array.isArray(data.photoURLs) ? [...data.photoURLs] : [];
                        
                        document.getElementById('messageTitle').value = data.title || '';
                        document.getElementById('messageDate').value = data.date || '';
                        document.getElementById('messageDescription').value = data.description || '';
                        document.getElementById('messageSubmit').textContent = 'Modifier la conversation 💕';
                        document.getElementById('cancelMessageEdit').style.display = 'block';
                        
                        // Reset preview et ajouter les photos existantes
                        const previewContainer = document.getElementById('messagePreview');
                        previewContainer.innerHTML = '';
                        
                        currentMessagePhotos.forEach(url => {
                            createPreviewWrapper(url, previewContainer, 'message', false);
                        });
                    }

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                container.appendChild(card);
            });
        }

        // Rendre la fonction openImageModal globale
        window.openImageModal = openImageModal;

        // Bouton Annuler la modification pour souvenirs
        const cancelMemoryBtn = document.createElement('button');
        cancelMemoryBtn.type = 'button';
        cancelMemoryBtn.id = 'cancelMemoryEdit';
        cancelMemoryBtn.className = 'submit-btn';
        cancelMemoryBtn.style.marginTop = '10px';
        cancelMemoryBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
        cancelMemoryBtn.style.display = 'none';
        cancelMemoryBtn.textContent = 'Annuler la modification';
        memoryForm.appendChild(cancelMemoryBtn);

        cancelMemoryBtn.addEventListener('click', () => {
            resetMemoryForm();
        });

        // Bouton Annuler la modification pour messages
        const cancelMessageBtn = document.createElement('button');
        cancelMessageBtn.type = 'button';
        cancelMessageBtn.id = 'cancelMessageEdit';
        cancelMessageBtn.className = 'submit-btn';
        cancelMessageBtn.style.marginTop = '10px';
        cancelMessageBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
        cancelMessageBtn.style.display = 'none';
        cancelMessageBtn.textContent = 'Annuler la modification';
        messageForm.appendChild(cancelMessageBtn);

        cancelMessageBtn.addEventListener('click', () => {
            resetMessageForm();
        });

        // Toggle affichage souvenirs/messages
        const memorySections = [
            document.querySelector("#memoryForm").closest(".admin-section"),
            document.querySelector("#deleteMemoriesList").closest(".admin-section")
        ];
        const messageSections = [
            document.querySelector("#messageForm").closest(".admin-section"),
            document.querySelector("#deleteMessagesList").closest(".admin-section")
        ];

        const memoriesBtn = document.getElementById("showMemoriesBtn");
        const messagesBtn = document.getElementById("showMessagesBtn");

        memoriesBtn.addEventListener("click", () => {
            memorySections.forEach(el => el.style.display = "block");
            messageSections.forEach(el => el.style.display = "none");

            memoriesBtn.classList.add("active");
            messagesBtn.classList.remove("active");
        });

        messagesBtn.addEventListener("click", () => {
            memorySections.forEach(el => el.style.display = "none");
            messageSections.forEach(el => el.style.display = "block");

            messagesBtn.classList.add("active");
            memoriesBtn.classList.remove("active");
        });

        // Initial state
        memoriesBtn.classList.add("active");
        messagesBtn.classList.remove("active");
        memoriesBtn.click();

        
    </script>
  <script>
    // Responsive navigation toggle
    document.getElementById("toggleMenu").addEventListener("click", () => {
      const nav = document.getElementById("navbarNav");
      if (nav.style.display === "flex") {
        nav.style.display = "none";
      } else {
        nav.style.display = "flex";
        nav.style.flexDirection = "column";
      }
    });
    // On load, hide nav menu on small screens
    function handleResizeNav() {
      const nav = document.getElementById("navbarNav");
      if (window.innerWidth <= 800) {
        nav.style.display = "none";
      } else {
        nav.style.display = "flex";
        nav.style.flexDirection = "row";
      }
    }
    window.addEventListener("resize", handleResizeNav);
    window.addEventListener("DOMContentLoaded", handleResizeNav);

    // Close menu if clicking outside (on body)
    document.body.addEventListener('click', function (e) {
      const toggleButton = document.getElementById("toggleMenu");
      const navMenu = document.getElementById("navbarNav");
      if (
        window.innerWidth <= 800 &&
        navMenu.style.display === "flex" &&
        !toggleButton.contains(e.target) &&
        !navMenu.contains(e.target)
      ) {
        navMenu.style.display = "none";
      }
    });
  </script>
</body>
    <div id="navbarGreeting" style="text-align: center; color: white; font-weight: 500; font-size: 14px; margin-top: 50px;"></div>
</html>